{"version":3,"sources":["../src/proctoring.js"],"names":["isCameraAllowed","define","$","Ajax","Notification","pictureCounter","setup","props","document","getElementById","innerHTML","length","height","streaming","data","append","video","canvas","photo","clearphoto","context","getContext","fillStyle","fillRect","width","toDataURL","setAttribute","takepicture","drawImage","webcampicture","params","courseid","id","quizid","call","methodname","args","done","warnings","addNotification","message","type","fail","exception","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","err","console","log","hideButtons","addEventListener","videoHeight","videoWidth","isNaN","ev","preventDefault","setTimeout","setInterval","init","startup","prop","html","on","checked"],"mappings":"AACA,GAAIA,CAAAA,eAAe,GAAnB,CAEAC,OAAM,oCAAC,CAAC,QAAD,CAAW,WAAX,CAAwB,mBAAxB,CAA6C,aAA7C,CAAD,CAA8D,SAAUC,CAAV,CAAaC,CAAb,CAAmBC,CAAnB,CAAyC,IAErGC,CAAAA,CAAc,CAAG,CAFoF,CAMzG,MAAO,CAGHC,KAAK,CAAE,eAAUC,CAAV,CAAiB,CAGpB,GAAuD,IAApD,EAAAC,QAAQ,CAACC,cAAT,CAAwB,uBAAxB,GAA4DD,QAAQ,CAACC,cAAT,CAAwB,uBAAxB,EAAiDC,SAAjD,CAA2DC,MAA1H,CAAiI,CAC7H,QACH,CACD,GAAsD,IAAnD,EAAAH,QAAQ,CAACC,cAAT,CAAwB,sBAAxB,GAA2DD,QAAQ,CAACC,cAAT,CAAwB,sBAAxB,EAAgDC,SAAhD,CAA0DC,MAAxH,CAA+H,CAC3H,QACH,CARmB,GAWhBC,CAAAA,CAAM,CAAG,CAXO,CAYhBC,CAAS,GAZO,CAahBC,CAAI,CAAG,IAbS,CAepBZ,CAAC,CAAC,oBAAD,CAAD,CAAwBa,MAAxB,CAA+B,4TAA/B,EAfoB,GAiBhBC,CAAAA,CAAK,CAAGR,QAAQ,CAACC,cAAT,CAAwB,OAAxB,CAjBQ,CAkBhBQ,CAAM,CAAGT,QAAQ,CAACC,cAAT,CAAwB,QAAxB,CAlBO,CAmBhBS,CAAK,CAAGV,QAAQ,CAACC,cAAT,CAAwB,OAAxB,CAnBQ,CAqBhBU,CAAU,CAAG,UAAY,CACzB,GAAIC,CAAAA,CAAO,CAAGH,CAAM,CAACI,UAAP,CAAkB,IAAlB,CAAd,CACAD,CAAO,CAACE,SAAR,CAAoB,MAApB,CACAF,CAAO,CAACG,QAAR,CAAiB,CAAjB,CAAoB,CAApB,CAAuBN,CAAM,CAACO,KAA9B,CAAqCP,CAAM,CAACL,MAA5C,EACAE,CAAI,CAAGG,CAAM,CAACQ,SAAP,CAAiB,WAAjB,CAAP,CACAP,CAAK,CAACQ,YAAN,CAAmB,KAAnB,CAA0BZ,CAA1B,CACH,CA3BmB,CA6BhBa,CAAW,CAAG,UAAY,CAC1B,GAAIP,CAAAA,CAAO,CAAGH,CAAM,CAACI,UAAP,CAAkB,IAAlB,CAAd,CACA,GAAaT,CAAb,CAAqB,CACjBK,CAAM,CAACO,KAAP,KACAP,CAAM,CAACL,MAAP,CAAgBA,CAAhB,CACAQ,CAAO,CAACQ,SAAR,CAAkBZ,CAAlB,CAAyB,CAAzB,CAA4B,CAA5B,KAAsCJ,CAAtC,EACAE,CAAI,CAAGG,CAAM,CAACQ,SAAP,CAAiB,WAAjB,CAAP,CACAP,CAAK,CAACQ,YAAN,CAAmB,KAAnB,CAA0BZ,CAA1B,EACAP,CAAK,CAACsB,aAAN,CAAsBf,CAAtB,CANiB,GASbgB,CAAAA,CAAM,CAAG,CACT,SAAYvB,CAAK,CAACwB,QADT,CAET,aAAgBxB,CAAK,CAACyB,EAFb,CAGT,OAAUzB,CAAK,CAAC0B,MAHP,CAIT,cAAiBnB,CAJR,CATI,CAqBjBX,CAAI,CAAC+B,IAAL,CAAU,CALI,CACVC,UAAU,qCADA,CAEVC,IAAI,CAAEN,CAFI,CAKJ,CAAV,EAAqB,CAArB,EAAwBO,IAAxB,CAA6B,SAAUvB,CAAV,CAAgB,CACzC,GAA2B,CAAvB,CAAAA,CAAI,CAACwB,QAAL,CAAc3B,MAAlB,CAA8B,CAE1BN,CAAc,EACjB,CAHD,IAGO,CACHD,CAAY,CAACmC,eAAb,CAA6B,CACzBC,OAAO,CAAE,gDADgB,CAEzBC,IAAI,CAAE,OAFmB,CAA7B,CAIH,CACJ,CAVD,EAUGC,IAVH,CAUQtC,CAAY,CAACuC,SAVrB,CAWH,CAhCD,IAgCO,CACHxB,CAAU,EACb,CACJ,CAlEmB,CAoEpByB,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC,CAAC9B,KAAK,GAAN,CAAc+B,KAAK,GAAnB,CAApC,EACKC,IADL,CACU,SAAUC,CAAV,CAAkB,CACpBjC,CAAK,CAACkC,SAAN,CAAkBD,CAAlB,CACAjC,CAAK,CAACmC,IAAN,GACAnD,eAAe,GAClB,CALL,EAMKoD,KANL,CAMW,SAAUC,CAAV,CAAe,CAClBC,OAAO,CAACC,GAAR,CAAY,sBAAwBF,CAApC,EAEAG,WAAW,EACd,CAVL,EAYI,GAAGxC,CAAH,CAAS,CACLA,CAAK,CAACyC,gBAAN,CAAuB,SAAvB,CAAkC,UAAc,CAC5C,GAAI,CAAC5C,CAAL,CAAgB,CACZD,CAAM,CAAGI,CAAK,CAAC0C,WAAN,EAAqB1C,CAAK,CAAC2C,UAAN,IAArB,CAAT,CAGA,GAAIC,KAAK,CAAChD,CAAD,CAAT,CAAmB,CACfA,CAAM,CAAG,KAAS,EAAI,CAAb,CACZ,CACDI,CAAK,CAACU,YAAN,CAAmB,OAAnB,MACAV,CAAK,CAACU,YAAN,CAAmB,QAAnB,CAA6Bd,CAA7B,EACAK,CAAM,CAACS,YAAP,CAAoB,OAApB,MACAT,CAAM,CAACS,YAAP,CAAoB,QAApB,CAA8Bd,CAA9B,EACAC,CAAS,GACZ,CACJ,CAdD,IAeH,CAhBD,IAgBO,CACH2C,WAAW,EACd,CAELxC,CAAK,CAACyC,gBAAN,CAAuB,OAAvB,CAAgC,SAAUI,CAAV,CAAc,CAC1ClC,CAAW,GACXkC,CAAE,CAACC,cAAH,EACH,CAHD,KAKAC,UAAU,CAACpC,CAAD,CA/GK,GA+GL,CAAV,CACAqC,WAAW,CAACrC,CAAD,CA/GK,GA+GL,CAEd,CA/GE,CAgHHsC,IAAI,CAAE,cAAU1D,CAAV,CAAiB,IAEfK,CAAAA,CAAM,CAAG,CAFM,CAGfC,CAAS,GAHM,CAIfG,CAAK,CAAG,IAJO,CAKfC,CAAM,CAAG,IALM,CAMfC,CAAK,CAAG,IANO,CAOfJ,CAAI,CAAG,IAPQ,CASnB,QAASoD,CAAAA,CAAT,EAAmB,CACflD,CAAK,CAAGR,QAAQ,CAACC,cAAT,CAAwB,OAAxB,CAAR,CACAQ,CAAM,CAAGT,QAAQ,CAACC,cAAT,CAAwB,QAAxB,CAAT,CACAS,CAAK,CAAGV,QAAQ,CAACC,cAAT,CAAwB,OAAxB,CAAR,CAEAmC,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC,CAAC9B,KAAK,GAAN,CAAc+B,KAAK,GAAnB,CAApC,EACKC,IADL,CACU,SAAUC,CAAV,CAAkB,CACpBjC,CAAK,CAACkC,SAAN,CAAkBD,CAAlB,CACAjC,CAAK,CAACmC,IAAN,GACAnD,eAAe,GAClB,CALL,EAMKoD,KANL,CAMW,SAAUC,CAAV,CAAe,CAClBC,OAAO,CAACC,GAAR,CAAY,sBAAwBF,CAApC,EAEAG,CAAW,EACd,CAVL,EAYI,GAAGxC,CAAH,CAAS,CACLA,CAAK,CAACyC,gBAAN,CAAuB,SAAvB,CAAkC,UAAc,CAC5C,GAAI,CAAC5C,CAAL,CAAgB,CACZD,CAAM,CAAGI,CAAK,CAAC0C,WAAN,EAAqB1C,CAAK,CAAC2C,UAAN,IAArB,CAAT,CAGA,GAAIC,KAAK,CAAChD,CAAD,CAAT,CAAmB,CACfA,CAAM,IACT,CACDI,CAAK,CAACU,YAAN,CAAmB,OAAnB,MACAV,CAAK,CAACU,YAAN,CAAmB,QAAnB,CAA6Bd,CAA7B,EACAK,CAAM,CAACS,YAAP,CAAoB,OAApB,MACAT,CAAM,CAACS,YAAP,CAAoB,QAApB,CAA8Bd,CAA9B,EACAC,CAAS,GACZ,CACJ,CAdD,IAeH,CAhBD,IAgBO,CACH2C,CAAW,EACd,CAGLxC,CAAK,CAACyC,gBAAN,CAAuB,OAAvB,CAAgC,SAAUI,CAAV,CAAc,CAC1ClC,CAAW,GACXkC,CAAE,CAACC,cAAH,EACH,CAHD,KAKA3C,CAAU,EACb,CAED,QAASA,CAAAA,CAAT,EAAsB,CAClB,GAAGnB,eAAH,CAAmB,CACf,GAAIoB,CAAAA,CAAO,CAAGH,CAAM,CAACI,UAAP,CAAkB,IAAlB,CAAd,CACAD,CAAO,CAACE,SAAR,CAAoB,MAApB,CACAF,CAAO,CAACG,QAAR,CAAiB,CAAjB,CAAoB,CAApB,CAAuBN,CAAM,CAACO,KAA9B,CAAqCP,CAAM,CAACL,MAA5C,EAEAE,CAAI,CAAGG,CAAM,CAACQ,SAAP,CAAiB,WAAjB,CAAP,CACAP,CAAK,CAACQ,YAAN,CAAmB,KAAnB,CAA0BZ,CAA1B,CACH,CAPD,IAOO,CACH0C,CAAW,EACd,CACJ,CAED,QAAS7B,CAAAA,CAAT,EAAuB,CACnB,GAAIP,CAAAA,CAAO,CAAGH,CAAM,CAACI,UAAP,CAAkB,IAAlB,CAAd,CACA,GAAaT,CAAb,CAAqB,CACjBK,CAAM,CAACO,KAAP,KACAP,CAAM,CAACL,MAAP,CAAgBA,CAAhB,CACAQ,CAAO,CAACQ,SAAR,CAAkBZ,CAAlB,CAAyB,CAAzB,CAA4B,CAA5B,KAAsCJ,CAAtC,EACAE,CAAI,CAAGG,CAAM,CAACQ,SAAP,CAAiB,WAAjB,CAAP,CACAP,CAAK,CAACQ,YAAN,CAAmB,KAAnB,CAA0BZ,CAA1B,EALiB,GASbgB,CAAAA,CAAM,CAAG,CACT,SAAYvB,CAAK,CAACwB,QADT,CAET,aAAgBxB,CAAK,CAACyB,EAFb,CAGT,OAAUzB,CAAK,CAAC0B,MAHP,CAIT,cAAiBnB,CAJR,CATI,CAqBjBX,CAAI,CAAC+B,IAAL,CAAU,CALI,CACVC,UAAU,qCADA,CAEVC,IAAI,CAAEN,CAFI,CAKJ,CAAV,EAAqB,CAArB,EAAwBO,IAAxB,CAA6B,SAAUvB,CAAV,CAAgB,CACzC,KAA2B,CAAvB,CAAAA,CAAI,CAACwB,QAAL,CAAc3B,MAAlB,EAEO,CACHP,CAAY,CAACmC,eAAb,CAA6B,CACzBC,OAAO,CAAE,gDADgB,CAEzBC,IAAI,CAAE,OAFmB,CAA7B,CAIH,CACJ,CATD,EASGC,IATH,CASQtC,CAAY,CAACuC,SATrB,CAWH,CAhCD,IAgCO,CACHxB,CAAU,EACb,CACJ,CAED,QAASqC,CAAAA,CAAT,EAAsB,CAClBtD,CAAC,CAAC,oBAAD,CAAD,CAAwBiE,IAAxB,CAA6B,UAA7B,KACAjE,CAAC,CAAC,aAAD,CAAD,CAAiBkE,IAAjB,CAAsB,+FAAtB,CACH,CAEDF,CAAO,GAEP,MAAOpD,CAAAA,CACV,CAnOE,CAqOV,CA3OK,CAAN,CA6OAZ,CAAC,CAAC,UAAU,CACRA,CAAC,CAAC,kBAAD,CAAD,CAAsBiE,IAAtB,CAA4B,UAA5B,KAEAjE,CAAC,CAAC,gBAAD,CAAD,CAAoBmE,EAApB,CAAuB,QAAvB,CAAiC,UAAU,CACvC,GAAG,KAAKC,OAAL,EAAgBtE,eAAnB,CAAoC,CAChCE,CAAC,CAAC,kBAAD,CAAD,CAAsBiE,IAAtB,CAA4B,UAA5B,IACH,CAFD,IAEK,CACDjE,CAAC,CAAC,kBAAD,CAAD,CAAsBiE,IAAtB,CAA4B,UAA5B,IACH,CACJ,CAND,CAQH,CAXA,CAAD,CAaA,QAASX,CAAAA,WAAT,EAAsB,CAClBtD,CAAC,CAAC,oBAAD,CAAD,CAAwBiE,IAAxB,CAA6B,UAA7B,KACAjE,CAAC,CAAC,aAAD,CAAD,CAAiBkE,IAAjB,CAAsB,+FAAtB,CACH","sourcesContent":["\nvar isCameraAllowed = false;\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/pubsub'], function ($, Ajax, Notification, PubSub) {\n    \n    var pictureCounter = 0;\n    var first_call_delay = 3000;    \n    var takepicture_delay = 30000;\n\n    return {\n\n        \n        setup: function (props) {\n\n            // skip for summary page\n            if(document.getElementById(\"page-mod-quiz-summary\") != null && document.getElementById(\"page-mod-quiz-summary\").innerHTML.length){\n                return false;\n            }\n            if(document.getElementById(\"page-mod-quiz-review\") != null && document.getElementById(\"page-mod-quiz-review\").innerHTML.length){\n                return false;\n            }\n\n            var width = 230;    // We will scale the photo width to this\n            var height = 0;     // This will be computed based on the input stream\n            var streaming = false;\n            var data = null;\n\n            $('#mod_quiz_navblock').append('<div class=\"card-body p-3\"><h3 class=\"no text-left\">Webcam</h3> <br/><video id=\"video\">Video stream not available.</video><canvas id=\"canvas\" style=\"display:none;\"></canvas> <div class=\"output\" style=\"display:none;\"><img id=\"photo\" alt=\"The screen capture will appear in this box.\"/></div> </div>');\n\n            var video = document.getElementById('video');\n            var canvas = document.getElementById('canvas');\n            var photo = document.getElementById('photo');\n\n            var clearphoto = function () {\n                var context = canvas.getContext('2d');\n                context.fillStyle = \"#AAA\";\n                context.fillRect(0, 0, canvas.width, canvas.height);\n                data = canvas.toDataURL('image/png');\n                photo.setAttribute('src', data);\n            }\n\n            var takepicture = function () {\n                var context = canvas.getContext('2d');\n                if (width && height) {\n                    canvas.width = width;\n                    canvas.height = height;\n                    context.drawImage(video, 0, 0, width, height);\n                    data = canvas.toDataURL('image/png');\n                    photo.setAttribute('src', data);\n                    props.webcampicture = data;\n                    \n                    var wsfunction = 'quizaccess_proctoring_send_camshot';\n                    var params = {\n                        'courseid': props.courseid,\n                        'screenshotid': props.id,\n                        'quizid': props.quizid,\n                        'webcampicture': data,\n                    };\n\n                    var request = {\n                        methodname: wsfunction,\n                        args: params\n                    };\n\n                    Ajax.call([request])[0].done(function (data) {\n                        if (data.warnings.length < 1) {\n                            // console.log(\"screenshot:\", pictureCounter,data);\n                            pictureCounter++;\n                        } else {\n                            Notification.addNotification({\n                                message: 'Something went wrong during taking screenshot.',\n                                type: 'error'\n                            });\n                        }\n                    }).fail(Notification.exception);\n                } else {\n                    clearphoto();\n                }\n            }\n\n            navigator.mediaDevices.getUserMedia({video: true, audio: false})\n                .then(function (stream) {\n                    video.srcObject = stream;\n                    video.play();\n                    isCameraAllowed = true;\n                })\n                .catch(function (err) {\n                    console.log(\"An error occurred: \" + err);\n\n                    hideButtons();\n                });\n\n                if(video){\n                    video.addEventListener('canplay', function (ev) {\n                        if (!streaming) {\n                            height = video.videoHeight / (video.videoWidth / width);\n                            // Firefox currently has a bug where the height can't be read from\n                            // the video, so we will make assumptions if this happens.\n                            if (isNaN(height)) {\n                                height = width / (4 / 3);\n                            }\n                            video.setAttribute('width', width);\n                            video.setAttribute('height', height);\n                            canvas.setAttribute('width', width);\n                            canvas.setAttribute('height', height);\n                            streaming = true;\n                        }\n                    }, false);\n                } else {\n                    hideButtons();\n                }\n            // allow to click picture\n            video.addEventListener('click', function (ev) {\n                takepicture();\n                ev.preventDefault();\n            }, false);\n\n            setTimeout(takepicture, first_call_delay);\n            setInterval(takepicture, takepicture_delay);\n\n        },\n        init: function (props) {\n            var width = 320;    // We will scale the photo width to this\n            var height = 0;     // This will be computed based on the input stream\n            var streaming = false;\n            var video = null;\n            var canvas = null;\n            var photo = null;\n            var data = null;\n\n            function startup() {\n                video = document.getElementById('video');\n                canvas = document.getElementById('canvas');\n                photo = document.getElementById('photo');\n\n                navigator.mediaDevices.getUserMedia({video: true, audio: false})\n                    .then(function (stream) {\n                        video.srcObject = stream;\n                        video.play();\n                        isCameraAllowed = true;\n                    })\n                    .catch(function (err) {\n                        console.log(\"An error occurred: \" + err);\n\n                        hideButtons();\n                    });\n\n                    if(video){\n                        video.addEventListener('canplay', function (ev) {\n                            if (!streaming) {\n                                height = video.videoHeight / (video.videoWidth / width);\n                                // Firefox currently has a bug where the height can't be read from\n                                // the video, so we will make assumptions if this happens.\n                                if (isNaN(height)) {\n                                    height = width / (4 / 3);\n                                }\n                                video.setAttribute('width', width);\n                                video.setAttribute('height', height);\n                                canvas.setAttribute('width', width);\n                                canvas.setAttribute('height', height);\n                                streaming = true;\n                            }\n                        }, false);\n                    } else {\n                        hideButtons();\n                    }\n\n                // allow to click picture\n                video.addEventListener('click', function (ev) {\n                    takepicture();\n                    ev.preventDefault();\n                }, false);\n\n                clearphoto();\n            }\n\n            function clearphoto() {\n                if(isCameraAllowed){\n                    var context = canvas.getContext('2d');\n                    context.fillStyle = \"#AAA\";\n                    context.fillRect(0, 0, canvas.width, canvas.height);\n\n                    data = canvas.toDataURL('image/png');\n                    photo.setAttribute('src', data);\n                } else {\n                    hideButtons();\n                }\n            }\n\n            function takepicture() {\n                var context = canvas.getContext('2d');\n                if (width && height) {\n                    canvas.width = width;\n                    canvas.height = height;\n                    context.drawImage(video, 0, 0, width, height);\n                    data = canvas.toDataURL('image/png');\n                    photo.setAttribute('src', data);\n                    // console.log(props);\n\n                    var wsfunction = 'quizaccess_proctoring_send_camshot';\n                    var params = {\n                        'courseid': props.courseid,\n                        'screenshotid': props.id,\n                        'quizid': props.quizid,\n                        'webcampicture': data,\n                    };\n\n                    var request = {\n                        methodname: wsfunction,\n                        args: params\n                    };\n\n                    Ajax.call([request])[0].done(function (data) {\n                        if (data.warnings.length < 1) {\n                            // console.log(data);\n                        } else {\n                            Notification.addNotification({\n                                message: 'Something went wrong during taking screenshot.',\n                                type: 'error'\n                            });\n                        }\n                    }).fail(Notification.exception);\n\n                } else {\n                    clearphoto();\n                }\n            }\n\n            function hideButtons(){\n                $('.mod_quiz-next-nav').prop(\"disabled\",true);\n                $('.submitbtns').html('<p class=\"text text-red red\">You need to enable web camera before submitting this quiz!</p>');\n            }\n\n            startup();\n\n            return data;\n        }\n    };\n});\n\n$(function(){\n    $('#id_submitbutton').prop( \"disabled\", true );\n\n    $('#id_proctoring').on('change', function(){\n        if(this.checked && isCameraAllowed) { \n            $('#id_submitbutton').prop( \"disabled\", false );\n        }else{\n            $('#id_submitbutton').prop( \"disabled\", true );\n        }\n    });\n\n});\n\nfunction hideButtons(){\n    $('.mod_quiz-next-nav').prop(\"disabled\",true);\n    $('.submitbtns').html('<p class=\"text text-red red\">You need to enable web camera before submitting this quiz!</p>');\n}\n"],"file":"proctoring.min.js"}